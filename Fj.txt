pipeline {
    agent any

    environment {
        AWS_ACCESS_KEY_ID     = credentials('aws-access-key')
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-key')
        AWS_REGION            = 'ap-south-1'
        S3_BUCKET             = 'front-end-eflow1'
        CLOUDFRONT_ID         = 'E1234567890'   // replace
    }

    tools {
        nodejs 'node20'   // Jenkins NodeJS tool name
    }

    stages {

        stage('Checkout Code') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/<your-repo>.git'
            }
        }

        stage('Clean Workspace') {
            steps {
                sh '''
                  rm -rf node_modules package-lock.json
                  npm cache clean --force
                '''
            }
        }

        stage('Install Dependencies') {
            steps {
                sh 'npm install --legacy-peer-deps --force'
            }
        }

        stage('Build Frontend') {
            steps {
                sh '''
                  npx tsc --skipLibCheck || echo "Ignoring TS errors"
                  npx vite build
                '''
            }
        }

        stage('Deploy to S3') {
            steps {
                sh '''
                  aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
                  aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
                  aws configure set region $AWS_REGION

                  aws s3 sync dist/ s3://$S3_BUCKET --delete
                '''
            }
        }

        stage('Invalidate CloudFront Cache') {
            steps {
                sh '''
                  aws cloudfront create-invalidation \
                    --distribution-id $CLOUDFRONT_ID \
                    --paths "/*"
                '''
            }
        }
    }

    post {
        success {
            echo "Frontend deployed successfully to S3 and CloudFront cache invalidated"
        }
        failure {
            echo " Deployment failed"
        }
    }
}
